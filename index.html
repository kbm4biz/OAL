<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Report Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e3f2fd;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 90%;
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #2196f3;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #1976d2;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2196f3;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin: 20px auto;
      animation: spin 1s linear infinite;
    }
    .error {
      color: #dc3545;
      margin: 15px 0;
    }
    .debug-info {
      font-size: 0.8em;
      color: #666;
      margin-top: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      word-break: break-word;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container" id="formContainer">
    <h2>Student Report Generator</h2>
    <form id="studentForm">
      <input type="text" id="studentId" 
             placeholder="Enter Student ID" 
             required
             pattern="\d+"
             title="Numbers only">
      <button type="submit">Generate Report</button>
    </form>
  </div>

  <div class="container hidden" id="loadingContainer">
    <h2>Processing Request</h2>
    <div class="loader"></div>
    <p id="timer">Elapsed time: 0s</p>
  </div>

  <div class="container hidden" id="responseContainer">
    <h2>Report Status</h2>
    <div id="responseContent"></div>
    <button onclick="resetForm()">New Report</button>
  </div>

  <div id="debugInfo" class="debug-info"></div>

  <script>
    const FLOW_URL = 'https://prod-208.westeurope.logic.azure.com:443/workflows/8229f59b7cca41a0b08627bdf2295a0a/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IAkb9M6kQOlJxtbx-tlELeVQkWKAE8rbh0QwjUXSQlU';
    const TIMEOUT_DURATION = 45000; // 45 seconds
    let startTime;
    let timerInterval;

    const ui = {
      form: document.getElementById('formContainer'),
      loading: document.getElementById('loadingContainer'),
      response: document.getElementById('responseContainer'),
      studentId: document.getElementById('studentId'),
      responseContent: document.getElementById('responseContent'),
      timer: document.getElementById('timer'),
      debug: document.getElementById('debugInfo')
    };

    function showElement(element) {
      element.classList.remove('hidden');
    }

    function hideElement(element) {
      element.classList.add('hidden');
    }

    function updateTimer() {
      const seconds = Math.floor((Date.now() - startTime) / 1000);
      ui.timer.textContent = `Elapsed time: ${seconds}s`;
    }

    function resetForm() {
      hideElement(ui.response);
      showElement(ui.form);
      ui.studentId.value = '';
      ui.debug.textContent = '';
    }

    async function handleResponse(response) {
      const contentType = response.headers.get('content-type');
      
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Invalid response format from server');
      }

      const data = await response.json();
      
      if (!data?.reportUrl) {
        throw new Error('Report URL missing in response');
      }

      return data.reportUrl;
    }

    async function submitRequest(studentId) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_DURATION);

      try {
        const response = await fetch(FLOW_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
        }

        return await handleResponse(response);
      } catch (error) {
        console.error('Submission Error:', error);
        throw error;
      }
    }

    ui.studentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      ui.debug.textContent = '';
      startTime = Date.now();
      
      hideElement(ui.form);
      hideElement(ui.response);
      showElement(ui.loading);
      
      timerInterval = setInterval(updateTimer, 1000);

      try {
        const reportUrl = await submitRequest(ui.studentId.value.trim());
        
        ui.responseContent.innerHTML = `
          <p>Report generated successfully!</p>
          <a href="${reportUrl}" target="_blank" 
             style="color: #2196f3; text-decoration: none;">
            View Report
          </a>
        `;
      } catch (error) {
        ui.responseContent.innerHTML = `
          <div class="error">⚠️ ${error.message}</div>
          <p>Please check the ID and try again</p>
        `;
        ui.debug.textContent = `Error Details: ${error.stack || error}`;
      } finally {
        clearInterval(timerInterval);
        hideElement(ui.loading);
        showElement(ui.response);
      }
    });
  </script>
</body>
</html>
