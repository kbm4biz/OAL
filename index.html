<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Report Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f8f9fa;
    }
    .response-section {
      margin: 10px 0;
      padding: 10px;
      background-color: white;
      border: 1px solid #ddd;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success { color: #2e7d32; }
    .error { color: #c62828; }
  </style>
</head>
<body>

<h1>Generate Student Report</h1>
<form id="reportForm">
  <label for="studentId">Student ID:</label>
  <input 
    type="text" 
    id="studentId" 
    name="studentId" 
    required
    pattern="\d+"
    title="Numbers only, please."
    inputmode="numeric"
  />
  <button type="submit">Generate Report</button>
</form>

<div id="output">
  <div class="response-section">
    <h3>Raw Response:</h3>
    <pre id="rawResponse"></pre>
  </div>
  <div class="response-section">
    <h3>Status:</h3>
    <div id="processedResult"></div>
  </div>
</div>

<script>
  const FLOW_URL = 'https://prod-156.westeurope.logic.azure.com:443/workflows/4255a7e944c347adac8f2230e02bc510/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Fo7cqwq3RB_57ntksgNijWDdNJU32nb0KQKUmo9KaHc';
  const POLL_INTERVAL = 2000; // 2 seconds
  const form = document.getElementById('reportForm');
  const rawResponsePre = document.getElementById('rawResponse');
  const resultDiv = document.getElementById('processedResult');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    // Reset UI
    rawResponsePre.textContent = '';
    resultDiv.innerHTML = 'Starting...';
    resultDiv.className = '';

    const studentId = document.getElementById('studentId').value.trim();
    if (!/^\d+$/.test(studentId)) {
      showError('Invalid Student ID - numbers only');
      return;
    }

    try {
      // Initial request
      const initResponse = await fetch(FLOW_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId })
      });

      // Handle 202 Accepted for async processing
      if (initResponse.status === 202) {
        const data = await initResponse.json();
        rawResponsePre.textContent = JSON.stringify(data, null, 2);
        await pollStatus(data.statusQueryUrl || data.properties.statusQueryUrl);
      } else {
        handleFinalResponse(await initResponse.json());
      }
      
    } catch (error) {
      showError(`Request failed: ${error.message}`);
    }
  });

  async function pollStatus(statusUrl) {
    try {
      let attempts = 0;
      const maxAttempts = 30; // 60 seconds total

      while (attempts < maxAttempts) {
        const response = await fetch(statusUrl);
        const data = await response.json();
        rawResponsePre.textContent = JSON.stringify(data, null, 2);
        
        updateStatusMessage(`Checking status (${attempts + 1}/${maxAttempts})...`);

        if (data.properties?.status === 'Succeeded') {
          if (data.properties.outputs?.body?.reportUrl) {
            handleSuccess(data.properties.outputs.body.reportUrl);
            return;
          }
          handleFinalResponse(data);
          return;
        }

        if (data.properties?.status === 'Failed') {
          throw new Error('Report generation failed on server');
        }

        await new Promise(resolve => setTimeout(resolve, POLL_INTERVAL));
        attempts++;
      }

      throw new Error('Timeout waiting for report');

    } catch (error) {
      showError(`Polling failed: ${error.message}`);
    }
  }

  function handleFinalResponse(data) {
    if (data.reportUrl) {
      handleSuccess(data.reportUrl);
    } else if (data.error) {
      throw new Error(data.error);
    } else {
      throw new Error('Unexpected response format');
    }
  }

  function handleSuccess(url) {
    resultDiv.className = 'success';
    resultDiv.innerHTML = `
      Report generated successfully!<br>
      <a href="${encodeURI(url)}" target="_blank" rel="noopener">
        View Report
      </a>
    `;
  }

  function updateStatusMessage(message) {
    resultDiv.textContent = message;
  }

  function showError(message) {
    resultDiv.className = 'error';
    resultDiv.textContent = message;
    console.error(message);
  }
</script>

</body>
</html>
