<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Report Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 0 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      cursor: pointer;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-height: 50px;
    }
    .success {
      background-color: #e8f5e9;
      border-color: #c8e6c9;
    }
    .error {
      background-color: #ffebee;
      border-color: #ffcdd2;
    }
  </style>
</head>
<body>

<h1>Generate Student Report</h1>
<form id="reportForm">
  <label for="studentId">Student ID:</label>
  <input 
    type="text" 
    id="studentId" 
    name="studentId" 
    required 
    pattern="\d+" 
    title="Numbers only, please."
  />
  <button type="submit">Generate Report</button>
</form>

<div id="output"></div>

<script>
  // Update this to your actual Flow's HTTP POST trigger URL
  const FLOW_URL = 'https://prod-208.westeurope.logic.azure.com:443/workflows/8229f59b7cca41a0b08627bdf2295a0a/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IAkb9M6kQOlJxtbx-tlELeVQkWKAE8rbh0QwjUXSQlU';

  // We'll set a longer timeout (80 seconds = 80000 ms).
  const FETCH_TIMEOUT = 80000;

  // Grab references
  const form = document.getElementById('reportForm');
  const outputDiv = document.getElementById('output');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    // Clear old messages
    outputDiv.className = '';
    outputDiv.textContent = 'Loading...';

    // Read the student ID
    const studentIdInput = document.getElementById('studentId');
    const studentId = studentIdInput.value.trim();

    // Prepare a controller to handle request timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT);

    try {
      // Make the POST request to the Flow
      const response = await fetch(FLOW_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId }),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`Server responded with status ${response.status}`);
      }

      // Parse JSON
      const data = await response.json();

      // Check if reportUrl is present
      if (!data?.reportUrl) {
        throw new Error('Response JSON did not contain reportUrl');
      }

      // Show success
      outputDiv.className = 'success';
      outputDiv.innerHTML = `
        <strong>Your report is ready!</strong><br>
        <a href="${data.reportUrl}" target="_blank">View Report</a>
      `;
    } catch (error) {
      console.error('Error:', error);
      let msg;
      if (error.name === 'AbortError') {
        msg = 'Request timed out. Please try again later.';
      } else {
        msg = 'Failed to generate report. Please check your input or try again.';
      }
      outputDiv.className = 'error';
      outputDiv.textContent = msg;
    }
  });
</script>

</body>
</html>
