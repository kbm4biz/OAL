<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Report Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e3f2fd;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 90%;
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #2196f3;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background-color: #1976d2;
    }
    #loading-container, #response-container {
      display: none;
    }
    .report-link {
      display: block;
      margin: 20px 0;
      color: #2196f3;
      text-decoration: none;
      word-break: break-all;
    }
    .report-link:hover {
      text-decoration: underline;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2196f3;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin: 20px auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #loading-message {
      color: #666;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container" id="form-container">
    <h2>Student Report Generator</h2>
    <form id="student-form">
      <input type="text" id="studentId" name="studentId" 
             placeholder="Enter Student ID" required
             pattern="\d+" title="Please enter numbers only">
      <button type="submit">Generate Report</button>
    </form>
  </div>

  <div class="container" id="loading-container">
    <h2>Processing Your Request</h2>
    <p id="loading-message">Starting report generation...</p>
    <div class="loader"></div>
  </div>

  <div class="container" id="response-container">
    <h2>Report Ready</h2>
    <div id="response-content"></div>
    <button onclick="showForm()">New Report</button>
  </div>

  <script>
    const FLOW_URL = 'https://prod-208.westeurope.logic.azure.com:443/workflows/8229f59b7cca41a0b08627bdf2295a0a/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IAkb9M6kQOlJxtbx-tlELeVQkWKAE8rbh0QwjUXSQlU';
    const FETCH_TIMEOUT = 40000; // 40 seconds timeout

    const containers = {
      form: document.getElementById('form-container'),
      loading: document.getElementById('loading-container'),
      response: document.getElementById('response-container')
    };
    const responseContent = document.getElementById('response-content');
    const loadingMessage = document.getElementById('loading-message');
    const form = document.getElementById('student-form');

    let startTime;
    let loadingInterval;

    function showForm() {
      containers.response.style.display = 'none';
      containers.form.style.display = 'block';
      form.reset();
    }

    function updateLoadingMessage() {
      const seconds = Math.floor((Date.now() - startTime) / 1000);
      loadingMessage.textContent = `Processing... (${seconds}s elapsed)`;
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      const studentId = document.getElementById('studentId').value.trim();

      // Reset state
      containers.form.style.display = 'none';
      containers.response.style.display = 'none';
      containers.loading.style.display = 'block';
      responseContent.innerHTML = '';
      startTime = Date.now();
      
      // Start loading timer
      loadingInterval = setInterval(updateLoadingMessage, 1000);
      updateLoadingMessage();

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT);

      try {
        const response = await fetch(FLOW_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }

        const data = await response.json();
        if (!data?.reportUrl) {
          throw new Error('Invalid response format from server');
        }

        responseContent.innerHTML = `
          <p>Your report is ready!</p>
          <a href="${data.reportUrl}" class="report-link" target="_blank">
            View Report
          </a>
        `;
      } catch (error) {
        console.error('Error:', error);
        const errorMessage = error.name === 'AbortError' 
          ? 'Request timed out. Please try again.' 
          : 'Failed to generate report. Please try again.';
        responseContent.textContent = errorMessage;
      } finally {
        clearInterval(loadingInterval);
        containers.loading.style.display = 'none';
        containers.response.style.display = 'block';
      }
    }

    form.addEventListener('submit', handleFormSubmit);
  </script>
</body>
</html>
