<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Report Generator</title>
  <style>
    /* Previous styles remain the same */
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 0 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      cursor: pointer;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-height: 50px;
    }
    .success {
      background-color: #e8f5e9;
      border-color: #c8e6c9;
    }
    .error {
      background-color: #ffebee;
      border-color: #ffcdd2;
    }
  </style>
</head>
<body>

<h1>Generate Student Report</h1>
<form id="reportForm">
  <label for="studentId">Student ID:</label>
  <input 
    type="text" 
    id="studentId" 
    name="studentId" 
    required
    pattern="\d+"
    title="Numbers only, please."
    inputmode="numeric"
  />
  <button type="submit">Generate Report</button>
</form>

<div id="output"></div>

<script>
  const FLOW_URL = 'https://prod-208.westeurope.logic.azure.com:443/workflows/8229f59b7cca41a0b08627bdf2295a0a/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IAkb9M6kQOlJxtbx-tlELeVQkWKAE8rbh0QwjUXSQlU';
  const FETCH_TIMEOUT = 80000;
  const form = document.getElementById('reportForm');
  const outputDiv = document.getElementById('output');

  const safeCreateLink = (url) => {
    const container = document.createElement('div');
    const link = document.createElement('a');
    link.href = encodeURI(url);
    link.textContent = 'View Report';
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    container.append('Your report is ready! ', link);
    return container;
  };

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    outputDiv.replaceChildren();
    outputDiv.className = '';
    
    const studentId = document.getElementById('studentId').value.trim();
    if (!/^\d+$/.test(studentId)) {
      outputDiv.className = 'error';
      outputDiv.textContent = 'Invalid Student ID - numbers only';
      return;
    }

    outputDiv.textContent = 'Generating report...';

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT);

    try {
      const response = await fetch(FLOW_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId }),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      // Check for JSON response
      const contentType = response.headers.get('content-type');
      if (!contentType?.includes('application/json')) {
        throw new Error('Invalid response format');
      }

      const data = await response.json();

      if (!response.ok || data.error) {
        throw new Error(data.error || `Server error: ${response.status}`);
      }

      if (!data.reportUrl) {
        throw new Error('Report URL missing in response');
      }

      // Safe HTML insertion
      outputDiv.className = 'success';
      outputDiv.appendChild(safeCreateLink(data.reportUrl));

    } catch (error) {
      console.error('Error:', error);
      outputDiv.className = 'error';
      outputDiv.textContent = error.name === 'AbortError' 
        ? 'Request timed out. Please try again later.' 
        : error.message.startsWith('Server error') 
          ? 'Server unavailable. Please try later.'
          : error.message || 'Failed to generate report. Check ID and try again.';
    }
  });
</script>

</body>
</html>
