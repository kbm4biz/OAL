<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Report Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f8f9fa;
    }
    .response-section {
      margin: 10px 0;
      padding: 10px;
      background-color: white;
      border: 1px solid #ddd;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>

<h1>Generate Student Report</h1>
<form id="reportForm">
  <label for="studentId">Student ID:</label>
  <input 
    type="text" 
    id="studentId" 
    name="studentId" 
    required
    pattern="\d+"
    title="Numbers only, please."
    inputmode="numeric"
  />
  <button type="submit">Generate Report</button>
</form>

<div id="output">
  <div class="response-section">
    <h3>Raw Response:</h3>
    <pre id="rawResponse"></pre>
  </div>
  <div class="response-section">
    <h3>Formatted Result:</h3>
    <div id="processedResult"></div>
  </div>
</div>

<script>
  const FLOW_URL = 'https://prod-208.westeurope.logic.azure.com:443/workflows/8229f59b7cca41a0b08627bdf2295a0a/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=IAkb9M6kQOlJxtbx-tlELeVQkWKAE8rbh0QwjUXSQlU';
  const FETCH_TIMEOUT = 80000;
  const form = document.getElementById('reportForm');
  const rawResponsePre = document.getElementById('rawResponse');
  const processedResultDiv = document.getElementById('processedResult');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    // Clear previous results
    rawResponsePre.textContent = 'Loading...';
    processedResultDiv.innerHTML = '';
    processedResultDiv.className = '';

    const studentId = document.getElementById('studentId').value.trim();
    if (!/^\d+$/.test(studentId)) {
      showError('Invalid Student ID - numbers only');
      return;
    }

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT);

    try {
      const response = await fetch(FLOW_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId }),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      // Capture raw response text
      const rawText = await response.text();
      rawResponsePre.textContent = rawText;

      // Try to parse JSON
      try {
        const data = JSON.parse(rawText);
        processedResultDiv.innerHTML = formatResponse(data);
        
        if (!response.ok) {
          throw new Error(data.error || `HTTP Error ${response.status}`);
        }
        
        if (data.reportUrl) {
          processedResultDiv.className = 'success';
          processedResultDiv.innerHTML += createLink(data.reportUrl);
        }
      } catch (e) {
        processedResultDiv.textContent = `JSON Parse Error: ${e.message}`;
      }

    } catch (error) {
      rawResponsePre.textContent = error.toString();
      processedResultDiv.className = 'error';
      processedResultDiv.textContent = error.message;
    }
  });

  function formatResponse(data) {
    return JSON.stringify(data, null, 2)
      .replace(/ /g, '&nbsp;')
      .replace(/\n/g, '<br>');
  }

  function createLink(url) {
    return `<br><a href="${encodeURI(url)}" target="_blank" rel="noopener">View Report</a>`;
  }

  function showError(message) {
    rawResponsePre.textContent = 'Client-side validation failed';
    processedResultDiv.className = 'error';
    processedResultDiv.textContent = message;
  }
</script>

</body>
</html>
